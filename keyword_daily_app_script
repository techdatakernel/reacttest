function copyDataWithoutFormulasV2() {
  var startTime = new Date();
  var currentStep = "ì´ˆê¸°í™”";
  var errorDetails = [];
  
  try {
    console.log("ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹œì‘");
    
    var sourceSpreadsheetId = "1l6t4onrNJg8YyePZV18Yg4319z6PT1Zp4mbaaTwjcuY";
    var sheetName = "ì„¸ìŠ¤ì½”í‚¤ì›Œë“œ_0820";
    var targetSpreadsheetId = "1T75q8crvVwrD6UFC9I6LqWFw-YU38pXLu4J4u5F2yB0";
    var targetSheetName = "ì„¸ìŠ¤ì½”í‚¤ì›Œë“œv2_0715";

    var spreadsheetId = "1nwWLGJPL8I8UAd7Cq2rHLUnOciCOhWeHylDgD0Nelho";
    var logSheetName = "Log";

    currentStep = "ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ê¸°";
    console.log("ì†ŒìŠ¤ ë° íƒ€ê²Ÿ ì‹œíŠ¸ ì—´ê¸°");
    
    var sourceSpreadsheet, targetSpreadsheet, sourceSheet, targetSheet;
    try {
      sourceSpreadsheet = SpreadsheetApp.openById(sourceSpreadsheetId);
      targetSpreadsheet = SpreadsheetApp.openById(targetSpreadsheetId);
      sourceSheet = sourceSpreadsheet.getSheetByName(sheetName);
      targetSheet = targetSpreadsheet.getSheetByName(targetSheetName);
      
      if (!sourceSheet) {
        throw new Error(`ì†ŒìŠ¤ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${sheetName}`);
      }
      if (!targetSheet) {
        throw new Error(`íƒ€ê²Ÿ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${targetSheetName}`);
      }
    } catch (sheetError) {
      throw new Error(`ì‹œíŠ¸ ì—´ê¸° ì‹¤íŒ¨: ${sheetError.message}`);
    }

    currentStep = "ê³µì‹ ë°±ì—…";
    console.log("ê³µì‹ ì œê±° ì‹œì‘");
    var formulaRange = targetSheet.getRange("K1:M1");
    var originalFormulas = formulaRange.getFormulas()[0];
    formulaRange.clearContent();

    currentStep = "ë‚ ì§œ ê³„ì‚°";
    console.log("ì–´ì œ ë‚ ì§œ ê³„ì‚°");
    var yesterday = new Date(new Date().getTime() - 24*60*60*1000);
    yesterday.setHours(0, 0, 0, 0);
    var yesterdayString = Utilities.formatDate(yesterday, "Asia/Seoul", "yyyy-MM-dd");
    
    // í…ŒìŠ¤íŠ¸ìš© ê³ ì • ë‚ ì§œ
   // var yesterdayString = "2025-08-11";

    console.log("ì–´ì œ ë‚ ì§œ: " + yesterdayString);

    currentStep = "ì†ŒìŠ¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°";
    console.log("ì†ŒìŠ¤ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œì‘");
    var data;
    try {
      data = sourceSheet.getDataRange().getValues();
      if (!data || data.length === 0) {
        throw new Error("ì†ŒìŠ¤ ì‹œíŠ¸ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
      }
    } catch (dataError) {
      throw new Error(`ì†ŒìŠ¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ${dataError.message}`);
    }

    currentStep = "ë°ì´í„° í•„í„°ë§";
    console.log("ì–´ì œ ë‚ ì§œì˜ ë°ì´í„° í•„í„°ë§");
    var yesterdayData = data.filter(function(row) {
      try {
        var date = new Date(row[0]);
        var dateString = Utilities.formatDate(date, "Asia/Seoul", "yyyy-MM-dd");
        return dateString === yesterdayString;
      } catch (filterError) {
        console.warn("ë‚ ì§œ í•„í„°ë§ ì¤‘ ì˜¤ë¥˜:", filterError.message);
        return false;
      }
    });

    console.log("ì–´ì œ ë‚ ì§œì˜ ë°ì´í„° " + yesterdayData.length + "ê°œ!");

    // ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ì²˜ë¦¬
    if (yesterdayData.length === 0) {
      console.log("ì–´ì œ ë‚ ì§œì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

      var endTime = new Date();
      var executionTime = endTime - startTime;
      var results = [
        "09 Keyword ìˆ˜ì§‘ Data",
        "ì–´ì œ ë‚ ì§œì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.",
        startTime,
        endTime,
        executionTime
      ];

      // ë¡œê·¸ ê¸°ë¡
      try {
        var spreadsheet = SpreadsheetApp.openById(spreadsheetId);
        var sheet = spreadsheet.getSheetByName(logSheetName);
        sheet.appendRow(results);
      } catch (logError) {
        console.error("ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨:", logError.message);
      }

      var body = "âš ï¸ ì–´ì œ ë‚ ì§œì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\n\n";
      body += "ì‹¤í–‰ ì •ë³´:\n";
      body += "- ëŒ€ìƒ ë‚ ì§œ: " + yesterdayString + "\n";
      body += "- ì‹¤í–‰ ì‹œê°„: " + startTime.toLocaleString() + "\n";
      body += "- ì†ŒìŠ¤ ì‹œíŠ¸: " + sheetName + "\n";
      body += "- ì „ì²´ ë°ì´í„° ìˆ˜: " + data.length + "ê°œ\n\n";
      body += "ì¡°ì¹˜ì‚¬í•­:\n";
      body += "1. ì†ŒìŠ¤ ë°ì´í„°ì— í•´ë‹¹ ë‚ ì§œ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸\n";
      body += "2. ë‚ ì§œ í˜•ì‹ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸\n";
      body += "3. í•„ìš”ì‹œ ìˆ˜ë™ìœ¼ë¡œ ë°ì´í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”";

      // ë©”ì¼ ì „ì†¡
      sendEmailResult2WithSubject("âš ï¸ ì„¸ìŠ¤ì½” í‚¤ì›Œë“œ ìŠ¤í¬ë¦½íŠ¸ - ë°ì´í„° ì—†ìŒ", body);
      
      return;
    }

    currentStep = "ê¸°ì¡´ ë°ì´í„° ì‚­ì œ";
    console.log("íƒ€ê²Ÿ ì‹œíŠ¸ì—ì„œ ì–´ì œ ë‚ ì§œì˜ ë°ì´í„° ì‚­ì œ ì‹œì‘");
    try {
      deleteFilteredRows(targetSheet, 1, yesterdayString);
    } catch (deleteError) {
      errorDetails.push(`ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜: ${deleteError.message}`);
      console.error("ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", deleteError.message);
      // ì‚­ì œ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
    }

    currentStep = "ìƒˆ ë°ì´í„° ì¶”ê°€";
    console.log("íƒ€ê²Ÿ ì‹œíŠ¸ì— ìƒˆ ë°ì´í„° ì¶”ê°€");
    try {
      var lastRow = targetSheet.getLastRow();
      if (yesterdayData.length > 0 && yesterdayData[0].length > 0) {
        targetSheet.getRange(lastRow + 1, 1, yesterdayData.length, yesterdayData[0].length).setValues(yesterdayData);
      }
    } catch (addError) {
      throw new Error(`ìƒˆ ë°ì´í„° ì¶”ê°€ ì‹¤íŒ¨: ${addError.message}`);
    }

    currentStep = "ê³µì‹ ë³µì›";
    console.log("ê³µì‹ ë³µì› ì‹œì‘");
    try {
      originalFormulas.forEach((formula, index) => {
        if (formula !== "") {
          targetSheet.getRange(1, 11 + index).setFormula(formula);
        }
      });
    } catch (formulaError) {
      errorDetails.push(`ê³µì‹ ë³µì› ì¤‘ ì˜¤ë¥˜: ${formulaError.message}`);
      console.error("ê³µì‹ ë³µì› ì¤‘ ì˜¤ë¥˜:", formulaError.message);
    }

    console.log("ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì™„ë£Œ");

    currentStep = "ì™„ë£Œ ì²˜ë¦¬";
    var endTime = new Date();
    var executionTime = endTime - startTime;
    var results = [
      "09 Keyword Yesterday Data",
      yesterdayData.length,
      startTime,
      endTime,
      executionTime
    ];

    // ë¡œê·¸ ê¸°ë¡
    try {
      var spreadsheet = SpreadsheetApp.openById(spreadsheetId);
      var sheet = spreadsheet.getSheetByName(logSheetName);
      sheet.appendRow(results);
    } catch (logError) {
      console.error("ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨:", logError.message);
    }

    // ì„±ê³µ ë©”ì¼ ë°œì†¡
    var successBody = "âœ… ì„¸ìŠ¤ì½” í‚¤ì›Œë“œ ìŠ¤í¬ë¦½íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\n";
    successBody += "ì‹¤í–‰ ê²°ê³¼:\n";
    successBody += "- ì²˜ë¦¬ ë‚ ì§œ: " + yesterdayString + "\n";
    successBody += "- ì²˜ë¦¬ëœ ë°ì´í„° ìˆ˜: " + yesterdayData.length + "ê°œ\n";
    successBody += "- ì‹¤í–‰ ì‹œê°„: " + (executionTime / 1000).toFixed(2) + "ì´ˆ\n";
    successBody += "- ì‹œì‘ ì‹œê°„: " + startTime.toLocaleString() + "\n";
    successBody += "- ì™„ë£Œ ì‹œê°„: " + endTime.toLocaleString() + "\n";
    
    if (errorDetails.length > 0) {
      successBody += "\nâš ï¸ ê²½ê³ ì‚¬í•­:\n";
      errorDetails.forEach(function(error, index) {
        successBody += (index + 1) + ". " + error + "\n";
      });
    }

    // ë©”ì¼ ì „ì†¡
    sendEmailResult2WithSubject("âœ… ì„¸ìŠ¤ì½” í‚¤ì›Œë“œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì„±ê³µ", successBody);

    // ë‹¤ìŒ í•¨ìˆ˜ ì˜ˆì•½
    scheduleNextFunction('mergeAndUpdateSheetsLastDate', 1);

  } catch (error) {
    console.error("ì˜¤ë¥˜ ë°œìƒ: " + error.message);
    
    // ì—ëŸ¬ ì•Œë¦¼ ë©”ì¼ ë°œì†¡
    sendErrorNotification2(error.message, currentStep, startTime, errorDetails);
    
    // ì—ëŸ¬ ë¡œê·¸ ê¸°ë¡
    try {
      var endTime = new Date();
      var executionTime = endTime - startTime;
      
      var errorResults = [
        "âŒ ERROR: " + currentStep,
        error.message,
        startTime,
        endTime,
        executionTime
      ];
      
      var spreadsheet = SpreadsheetApp.openById("1nwWLGJPL8I8UAd7Cq2rHLUnOciCOhWeHylDgD0Nelho");
      var sheet = spreadsheet.getSheetByName("Log");
      sheet.appendRow(errorResults);
      
    } catch (logError) {
      console.error("ì—ëŸ¬ ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨:", logError.message);
    }
    
    // ì—ëŸ¬ë¥¼ ë‹¤ì‹œ ë˜ì ¸ì„œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ì´ ì‹¤íŒ¨ë¡œ ê¸°ë¡ë˜ë„ë¡ í•¨
    throw error;
  }
}

// ì—ëŸ¬ ì•Œë¦¼ ë©”ì¼ ë°œì†¡ í•¨ìˆ˜
function sendErrorNotification2(errorMessage, currentStep, startTime, additionalErrors) {
  try {
    var endTime = new Date();
    var executionTime = endTime - startTime;
    
    var subject = "ğŸš¨ ì„¸ìŠ¤ì½” í‚¤ì›Œë“œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨";
    
    var body = "âŒ ì„¸ìŠ¤ì½” í‚¤ì›Œë“œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n";
    body += "ğŸ“ ì˜¤ë¥˜ ë°œìƒ ë‹¨ê³„: " + currentStep + "\n";
    body += "ğŸ• ì‹œì‘ ì‹œê°„: " + startTime.toLocaleString() + "\n";
    body += "ğŸ• ì˜¤ë¥˜ ë°œìƒ ì‹œê°„: " + endTime.toLocaleString() + "\n";
    body += "â±ï¸ ì‹¤í–‰ ì‹œê°„: " + (executionTime / 1000).toFixed(2) + "ì´ˆ\n\n";
    
    body += "ğŸ” ì£¼ìš” ì˜¤ë¥˜:\n";
    body += errorMessage + "\n\n";
    
    if (additionalErrors && additionalErrors.length > 0) {
      body += "âš ï¸ ì¶”ê°€ ì˜¤ë¥˜ ì‚¬í•­:\n";
      additionalErrors.forEach(function(error, index) {
        body += (index + 1) + ". " + error + "\n";
      });
      body += "\n";
    }
    
    body += "ğŸ”§ ì¡°ì¹˜ ë°©ë²•:\n";
    body += "1. Google Apps Script ì½˜ì†”ì—ì„œ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”\n";
    body += "2. ì†ŒìŠ¤ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì ‘ê·¼ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”\n";
    body += "3. íƒ€ê²Ÿ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì ‘ê·¼ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”\n";
    body += "4. ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”\n";
    body += "5. í•„ìš”ì‹œ ìˆ˜ë™ìœ¼ë¡œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¬ì‹¤í–‰í•˜ì„¸ìš”\n\n";
    
    body += "ğŸ“Š ì‹œìŠ¤í…œ ì •ë³´:\n";
    body += "- ìŠ¤í¬ë¦½íŠ¸ëª…: copyDataWithoutFormulas2\n";
    body += "- ì†ŒìŠ¤ ì‹œíŠ¸: ì„¸ìŠ¤ì½”í‚¤ì›Œë“œ_0731\n";
    body += "- íƒ€ê²Ÿ ì‹œíŠ¸: ì„¸ìŠ¤ì½”í‚¤ì›Œë“œv2_0715\n";
    
    MailApp.sendEmail("adminpmp@aaa.com", subject, body);
    console.log("ì—ëŸ¬ ì•Œë¦¼ ë©”ì¼ ë°œì†¡ ì™„ë£Œ");
    
  } catch (mailError) {
    console.error("ì—ëŸ¬ ì•Œë¦¼ ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨:", mailError.message);
  }
}

// ì œëª©ì„ ì§€ì •í•  ìˆ˜ ìˆëŠ” ë©”ì¼ ë°œì†¡ í•¨ìˆ˜
function sendEmailResult2WithSubject(subject, body) {
  try {
    MailApp.sendEmail("adminpmp@miraepmp.com", subject, body);
    console.log("ê²°ê³¼ ì•Œë¦¼ ë©”ì¼ ë°œì†¡ ì™„ë£Œ:", subject);
  } catch (mailError) {
    console.error("ê²°ê³¼ ì•Œë¦¼ ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨:", mailError.message);
  }
}

// ê¸°ì¡´ ë©”ì¼ ë°œì†¡ í•¨ìˆ˜ (í˜¸í™˜ì„± ìœ ì§€)
function sendEmailResult2(body) { 
  var subject = "ì„¸ìŠ¤ì½” í‚¤ì›Œë“œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê²°ê³¼";
  sendEmailResult2WithSubject(subject, body);
}

// ì¦‰ì‹œ ì—ëŸ¬ ì•Œë¦¼ì„ ìœ„í•œ í—¬í¼ í•¨ìˆ˜
function notifyError2(step, error) {
  try {
    var quickSubject = "ğŸš¨ ì¦‰ì‹œ ì•Œë¦¼ - " + step + " ì‹¤íŒ¨";
    var quickBody = "ë‹¨ê³„: " + step + "\n";
    quickBody += "ì‹œê°„: " + new Date().toLocaleString() + "\n";
    quickBody += "ì˜¤ë¥˜: " + error.message + "\n\n";
    quickBody += "ìƒì„¸ ì •ë³´ëŠ” ê³§ ë³„ë„ ë©”ì¼ë¡œ ë°œì†¡ë©ë‹ˆë‹¤.";
    
    MailApp.sendEmail("adminpmp@aaa.com", quickSubject, quickBody);
  } catch (e) {
    console.error("ì¦‰ì‹œ ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨:", e.message);
  }
}

// ê¸°ì¡´ í•¨ìˆ˜ë“¤ (scheduleNextFunction, deleteTriggerByFunctionName, mergeAndUpdateSheetsLastDate, deleteFilteredRows)
function scheduleNextFunction(functionName, delayInMinutes) {
  console.log(`${functionName} ì‹¤í–‰ ì˜ˆì•½ ì‹œì‘`);
  
  // ê¸°ì¡´ íŠ¸ë¦¬ê±° ì‚­ì œ
  deleteTriggerByFunctionName(functionName);
  
  // ìƒˆ íŠ¸ë¦¬ê±° ìƒì„±
  ScriptApp.newTrigger(functionName)
    .timeBased()
    .after(delayInMinutes * 60 * 1000)
    .create();
  
  console.log(`${functionName} ì‹¤í–‰ì´ ${delayInMinutes}ë¶„ í›„ë¡œ ì˜ˆì•½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
}

function deleteTriggerByFunctionName(functionName) {
  var triggers = ScriptApp.getProjectTriggers();
  for (var i = 0; i < triggers.length; i++) {
    if (triggers[i].getHandlerFunction() == functionName) {
      ScriptApp.deleteTrigger(triggers[i]);
      console.log(`${functionName}ì— ëŒ€í•œ ê¸°ì¡´ íŠ¸ë¦¬ê±°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }
  }
}

function mergeAndUpdateSheetsLastDate() {
  console.log("2ë‹¨ê³„ ìŠ¤í¬ë¦½íŠ¸ í•¨ìˆ˜ ì‹¤í–‰ ì‹œì‘: mergeAndUpdateSheetsLastDate");
  // í•¨ìˆ˜ ë¡œì§
  console.log("2ë‹¨ê³„ ìŠ¤í¬ë¦½íŠ¸ í•¨ìˆ˜ ì‹¤í–‰ ì™„ë£Œ: mergeAndUpdateSheetsLastDate");
  
  // ì´ í•¨ìˆ˜ì˜ íŠ¸ë¦¬ê±° ì‚­ì œ
  deleteTriggerByFunctionName('mergeAndUpdateSheetsLastDate');
}

function deleteFilteredRows(targetSheet, filterColumn, filterValue) {
  try {
    const targetLastRow = targetSheet.getLastRow();
    if (targetLastRow <= 1) return; // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ

    const targetData = targetSheet.getRange(2, 1, targetLastRow - 1, targetSheet.getLastColumn()).getValues(); // ì²« ë²ˆì§¸ í–‰ ì œì™¸
    let rowsToDelete = [];
    let startRow = null;

    for (let i = 0; i < targetData.length; i++) {
      try {
        var date = new Date(targetData[i][filterColumn - 1]);
        var dateString = Utilities.formatDate(date, "Asia/Seoul", "yyyy-MM-dd");
        if (dateString === filterValue) {
          if (startRow === null) startRow = i + 2; // 2í–‰ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ 2ë¥¼ ë”í•¨
        } else {
          if (startRow !== null) {
            rowsToDelete.push({start: startRow, end: i + 1});
            startRow = null;
          }
        }
      } catch (dateError) {
        console.warn(`í–‰ ${i + 2} ë‚ ì§œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:`, dateError.message);
        continue;
      }
    }

    // ë§ˆì§€ë§‰ ë²”ìœ„ ì²˜ë¦¬
    if (startRow !== null) {
      rowsToDelete.push({start: startRow, end: targetData.length + 1});
    }

    // ë’¤ì—ì„œë¶€í„° ì‚­ì œ
    let totalDeletedRows = 0;
    for (let i = rowsToDelete.length - 1; i >= 0; i--) {
      const range = rowsToDelete[i];
      const rowsCount = range.end - range.start + 1;
      try {
        targetSheet.deleteRows(range.start, rowsCount);
        totalDeletedRows += rowsCount;
      } catch (deleteError) {
        console.error(`í–‰ ì‚­ì œ ì¤‘ ì˜¤ë¥˜: ${deleteError.message}`);
        throw deleteError;
      }
    }

    console.log(`ì‚­ì œëœ í–‰ ìˆ˜: ${totalDeletedRows}`);
    
  } catch (error) {
    console.error("deleteFilteredRows í•¨ìˆ˜ ì˜¤ë¥˜:", error.message);
    throw error;
  }
}
