function copyDataWithoutFormulasMetav3() {
  console.log("ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹œì‘");
  
  var startTime = new Date();
  var sourceSpreadsheetId = "1kpz-UONsOieiusTtYWKlYSF59We9O20as1hYPPvallo";
  var sourceSheetName = "Facebook Cass";
  var targetSpreadsheetId = "1FP9DCAv2NzdiHLySmYRy4tB4tx9ak_wGFA4e0jwuenE";
  var targetSheetName = "Meta_API";
  const filterColumn = 46; // Vì—´

  var spreadsheetId = "1nwWLGJPL8I8UAd7Cq2rHLUnOciCOhWeHylDgD0Nelho";
  var sheetName = "ë¸Œëœë”©";
  
  // ì—ëŸ¬ ì¶”ì ì„ ìœ„í•œ ë³€ìˆ˜ë“¤
  var currentStep = "ì´ˆê¸°í™”";
  var errorDetails = [];

  try {
    // ì„¤ì •í•  WEEK ë²”ìœ„
    const validWeeks = ["WK27", "WK28", "WK29", "WK30", "WK31"];

    // í•„í„°ë§í•  ê°’ (ì–´ì œ ë‚ ì§œ ê¸°ì¤€ Weeknum ê³„ì‚°)
    currentStep = "ì£¼ì°¨ ê³„ì‚°";
 

         const filterValue1 = getLastWeekWeeknum();

//const filterValue1 = "WK30"

    console.log("í•„í„°ë§í•  ê°’:", filterValue1);

    // í•„í„°ë§í•  ê°’ì´ ì„¤ì •ëœ WEEK ë²”ìœ„ì— í¬í•¨ë˜ì§€ ì•Šìœ¼ë©´ ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ
    if (!validWeeks.includes(filterValue1)) {
      var endReason = "í•„í„°ë§í•  ê°’ì´ ìœ íš¨í•œ WEEK ë²”ìœ„ì— í¬í•¨ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.";
      console.log(endReason);
      
      // ì¢…ë£Œ ì•Œë¦¼ ë©”ì¼ ë°œì†¡
      sendErrorNotification("ìŠ¤í¬ë¦½íŠ¸ ì¡°ê¸° ì¢…ë£Œ", endReason, currentStep, startTime);
      return;
    }

    const BATCH_SIZE = 5000; // í•œë²ˆì— ì²˜ë¦¬í•  í–‰ ìˆ˜

    currentStep = "ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ê¸°";
    console.log("ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë° ì‹œíŠ¸ ì—´ê¸° ì‹œì‘");
    
    var sourceSheet, targetSheet;
    try {
      sourceSheet = SpreadsheetApp.openById(sourceSpreadsheetId).getSheetByName(sourceSheetName);
      if (!sourceSheet) {
        throw new Error(`ì†ŒìŠ¤ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${sourceSheetName}`);
      }
      
      targetSheet = SpreadsheetApp.openById(targetSpreadsheetId).getSheetByName(targetSheetName);
      if (!targetSheet) {
        throw new Error(`íƒ€ê²Ÿ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${targetSheetName}`);
      }
      
      console.log("ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë° ì‹œíŠ¸ ì—´ê¸° ì™„ë£Œ");
    } catch (sheetError) {
      throw new Error(`ì‹œíŠ¸ ì—´ê¸° ì‹¤íŒ¨: ${sheetError.message}`);
    }

    currentStep = "ê³µì‹ ë°±ì—…";
    console.log("ê¸°ì¡´ ê³µì‹ ì €ì¥ ì‹œì‘");
    var formulaRange = targetSheet.getRange("CC1:CO1");
    var originalFormulas = formulaRange.getFormulas()[0];
    console.log("ê¸°ì¡´ ê³µì‹ ì €ì¥ ì™„ë£Œ");

    console.log("ê¸°ì¡´ ê³µì‹ ì„ì‹œ ì œê±° ì‹œì‘");
    formulaRange.clearContent();
    console.log("ê¸°ì¡´ ê³µì‹ ì„ì‹œ ì œê±° ì™„ë£Œ");

    currentStep = "ë°ì´í„° ì‚­ì œ";
    console.log("íƒ€ê²Ÿ ì‹œíŠ¸ì—ì„œ í•„í„°ë§ëœ ë°ì´í„° ì‚­ì œ ì‹œì‘");
    try {
      deleteFilteredRowsMetav2(targetSheet, filterColumn, filterValue1);
      console.log("íƒ€ê²Ÿ ì‹œíŠ¸ì—ì„œ í•„í„°ë§ëœ ë°ì´í„° ì‚­ì œ ì™„ë£Œ");
    } catch (deleteError) {
      // ì‚­ì œ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰í•˜ë˜ ì—ëŸ¬ ê¸°ë¡
      errorDetails.push(`ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜: ${deleteError.message}`);
      console.error("ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", deleteError.message);
    }

    currentStep = "ì†ŒìŠ¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°";
    console.log("ì†ŒìŠ¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œì‘");
    var sourceData;
    try {
      const sourceLastRow = sourceSheet.getLastRow();
      if (sourceLastRow < 3) {
        throw new Error("ì†ŒìŠ¤ ì‹œíŠ¸ì— ì¶©ë¶„í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
      }
      
      sourceData = sourceSheet.getRange("A3:CA" + sourceLastRow).getValues();
      console.log("ì†ŒìŠ¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ. ì´ " + sourceData.length + "í–‰ì˜ ë°ì´í„°");
    } catch (sourceError) {
      throw new Error(`ì†ŒìŠ¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ${sourceError.message}`);
    }

    currentStep = "ë°ì´í„° í•„í„°ë§";
    console.log("í•„í„°ë§ëœ ì†ŒìŠ¤ ë°ì´í„° ì¤€ë¹„ ì‹œì‘");
    var filteredSourceData = sourceData.filter(function(row) {
      return row && row.length > filterColumn - 1 && row[filterColumn - 1] === filterValue1;
    }).map(function(row) {
      // ë‚ ì§œ ì—´ì˜ ì¸ë±ìŠ¤ë¥¼ ì°¾ì•„ í˜•ì‹ ë³€í™˜
      var dateColumnIndex = 0;
      if (row[dateColumnIndex]) {
        row[dateColumnIndex] = formatDate(row[dateColumnIndex]);
      }
      return row;
    });
    console.log("í•„í„°ë§ëœ ì†ŒìŠ¤ ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ. ì´ " + filteredSourceData.length + "í–‰ì˜ ë°ì´í„°");

    currentStep = "ë°ì´í„° ì¶”ê°€";
    console.log("í•„í„°ë§ëœ ë°ì´í„° ì¶”ê°€ ì‹œì‘");
    var lastRow = targetSheet.getLastRow();
    
    if (filteredSourceData.length > 0) {
      // ë°ì´í„°ë¥¼ ë¶„í• í•˜ì—¬ ì¶”ê°€
      for (var i = 0; i < filteredSourceData.length; i += BATCH_SIZE) {
        try {
          var batchData = filteredSourceData.slice(i, i + BATCH_SIZE);
          if (batchData.length > 0 && batchData[0].length > 0) {
            targetSheet.getRange(lastRow + 1, 1, batchData.length, batchData[0].length).setValues(batchData);
            lastRow += batchData.length;
            console.log("ì¶”ê°€ëœ í–‰ ìˆ˜: " + batchData.length);
            Utilities.sleep(500); // 0.5ì´ˆ ëŒ€ê¸°
          }
        } catch (batchError) {
          errorDetails.push(`ë°°ì¹˜ ${i} ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ${batchError.message}`);
          console.error(`ë°°ì¹˜ ${i} ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:`, batchError.message);
          // ë°°ì¹˜ ì‹¤íŒ¨í•´ë„ ë‹¤ìŒ ë°°ì¹˜ ê³„ì† ì²˜ë¦¬
        }
      }
    }
    console.log("í•„í„°ë§ëœ ë°ì´í„° ì¶”ê°€ ì™„ë£Œ");

    currentStep = "ê³µì‹ ë³µì›";
    console.log("ê³µì‹ ë³µì› ì‹œì‘");
    try {
      for (var i = 0; i < originalFormulas.length; i++) {
        if (originalFormulas[i] !== "") {
          targetSheet.getRange(1, 81 + i).setFormula(originalFormulas[i]);
        }
      }
      console.log("ê³µì‹ ë³µì› ì™„ë£Œ");
    } catch (formulaError) {
      errorDetails.push(`ê³µì‹ ë³µì› ì¤‘ ì˜¤ë¥˜: ${formulaError.message}`);
      console.error("ê³µì‹ ë³µì› ì¤‘ ì˜¤ë¥˜:", formulaError.message);
    }

    console.log("ìµœì¢… í–‰ ìˆ˜ í™•ì¸: " + lastRow);
    console.log("ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì™„ë£Œ");

    // ì„±ê³µ ì™„ë£Œ ë¡œê·¸ ë° ë©”ì¼
    currentStep = "ì™„ë£Œ ì²˜ë¦¬";
    var endTime = new Date();
    var executionTime = endTime - startTime;

    var results = [
      filterValue1 + "í•œë§¥ Meta Data",
      lastRow,
      startTime,
      endTime,
      executionTime
    ];

    // ë¡œê·¸ ì‹œíŠ¸ì— ê¸°ë¡
    try {
      var spreadsheetLogId = "1x_Bka1skHPQDUey1R51UN1rfmkWO3CTnIfkTPHdUYsk";
      var logSheetName = "Log";
      var spreadsheetLog = SpreadsheetApp.openById(spreadsheetLogId);
      var sheetLog = spreadsheetLog.getSheetByName(logSheetName);

      var Today2 = getFormattedDate();
      var results2 = [Today2, startTime];
      
      sheetLog.appendRow(results2);

      var spreadsheet = SpreadsheetApp.openById(spreadsheetId);
      var sheet = spreadsheet.getSheetByName(sheetName);
      sheet.appendRow(results);
      
      console.log("ë¡œê·¸ ê¸°ë¡ ì™„ë£Œ");
    } catch (logError) {
      console.error("ë¡œê·¸ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜:", logError.message);
    }

    // ì„±ê³µ ì•Œë¦¼ ë©”ì¼ ë°œì†¡
    var successBody = "âœ… ìŠ¤í¬ë¦½íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\n";
    successBody += "ì‹¤í–‰ ê²°ê³¼:\n";
    successBody += "- í•„í„° ê°’: " + filterValue1 + "\n";
    successBody += "- ì²˜ë¦¬ëœ í–‰ ìˆ˜: " + lastRow + "\n";
    successBody += "- ì‹¤í–‰ ì‹œê°„: " + (executionTime / 1000).toFixed(2) + "ì´ˆ\n";
    
    if (errorDetails.length > 0) {
      successBody += "\nâš ï¸ ê²½ê³ ì‚¬í•­:\n";
      errorDetails.forEach(function(error, index) {
        successBody += (index + 1) + ". " + error + "\n";
      });
    }
    
    sendEmailResult("ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì„±ê³µ", successBody);

  } catch (mainError) {
    // ë©”ì¸ ì—ëŸ¬ ì²˜ë¦¬ ë° ì•Œë¦¼
    console.error("ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ ì—ëŸ¬:", mainError.message);
    console.error("ì—ëŸ¬ ìŠ¤íƒ:", mainError.stack);
    
    sendErrorNotification("ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨", mainError.message, currentStep, startTime, errorDetails);
    
    // ì—ëŸ¬ ë¡œê·¸ë„ ê¸°ë¡
    try {
      var endTime = new Date();
      var executionTime = endTime - startTime;
      
      var errorResults = [
        "âŒ ERROR: " + currentStep,
        mainError.message,
        startTime,
        endTime,
        executionTime
      ];
      
      var spreadsheetLogId = "1x_Bka1skHPQDUey1R51UN1rfmkWO3CTnIfkTPHdUYsk";
      var spreadsheetLog = SpreadsheetApp.openById(spreadsheetLogId);
      var sheetLog = spreadsheetLog.getSheetByName("Log");
      sheetLog.appendRow(errorResults);
      
    } catch (logError) {
      console.error("ì—ëŸ¬ ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨:", logError.message);
    }
    
    throw mainError;
  }
}

// ì—ëŸ¬ ì•Œë¦¼ ë©”ì¼ ë°œì†¡ í•¨ìˆ˜
function sendErrorNotification(errorType, errorMessage, currentStep, startTime, additionalErrors) {
  try {
    var endTime = new Date();
    var executionTime = endTime - startTime;
    
    var subject = "ğŸš¨ " + errorType + " - Google Apps Script";
    
    var body = "âŒ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n";
    body += "ğŸ“ ì˜¤ë¥˜ ë°œìƒ ë‹¨ê³„: " + currentStep + "\n";
    body += "ğŸ• ì‹œì‘ ì‹œê°„: " + startTime.toLocaleString() + "\n";
    body += "ğŸ• ì˜¤ë¥˜ ë°œìƒ ì‹œê°„: " + endTime.toLocaleString() + "\n";
    body += "â±ï¸ ì‹¤í–‰ ì‹œê°„: " + (executionTime / 1000).toFixed(2) + "ì´ˆ\n\n";
    
    body += "ğŸ” ì£¼ìš” ì˜¤ë¥˜:\n";
    body += errorMessage + "\n\n";
    
    if (additionalErrors && additionalErrors.length > 0) {
      body += "âš ï¸ ì¶”ê°€ ì˜¤ë¥˜ ì‚¬í•­:\n";
      additionalErrors.forEach(function(error, index) {
        body += (index + 1) + ". " + error + "\n";
      });
      body += "\n";
    }
    
    body += "ğŸ”§ ì¡°ì¹˜ ë°©ë²•:\n";
    body += "1. Google Apps Script ì½˜ì†”ì—ì„œ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”\n";
    body += "2. ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”\n";
    body += "3. ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”\n";
    body += "4. í•„ìš”ì‹œ ìˆ˜ë™ìœ¼ë¡œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¬ì‹¤í–‰í•˜ì„¸ìš”\n\n";
    
    body += "ğŸ“Š ì‹œìŠ¤í…œ ì •ë³´:\n";
    body += "- ìŠ¤í¬ë¦½íŠ¸ëª…: copyDataWithoutFormulasMeta\n";
    body += "- ì‹¤í–‰ ID: " + Session.getTemporaryActiveUserKey() + "\n";
    
    MailApp.sendEmail("adminpmp@miraepmp.com", subject, body);
    console.log("ì—ëŸ¬ ì•Œë¦¼ ë©”ì¼ ë°œì†¡ ì™„ë£Œ");
    
  } catch (mailError) {
    console.error("ì—ëŸ¬ ì•Œë¦¼ ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨:", mailError.message);
  }
}

// ì„±ê³µ ì•Œë¦¼ ë©”ì¼ ë°œì†¡ í•¨ìˆ˜ (ê¸°ì¡´ í•¨ìˆ˜ ê°œì„ )
function sendEmailResult(subject, body) {
  try {
    var fullSubject = subject || "Google Apps Script ì‹¤í–‰ ê²°ê³¼";
    MailApp.sendEmail("adminpmp@miraepmp.com", fullSubject, body);
    console.log("ê²°ê³¼ ì•Œë¦¼ ë©”ì¼ ë°œì†¡ ì™„ë£Œ");
  } catch (mailError) {
    console.error("ê²°ê³¼ ì•Œë¦¼ ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨:", mailError.message);
  }
}

// ì¦‰ì‹œ ì—ëŸ¬ ì•Œë¦¼ì„ ìœ„í•œ í—¬í¼ í•¨ìˆ˜
function notifyError(step, error) {
  try {
    var quickSubject = "ğŸš¨ ì¦‰ì‹œ ì•Œë¦¼ - " + step + " ì‹¤íŒ¨";
    var quickBody = "ë‹¨ê³„: " + step + "\n";
    quickBody += "ì‹œê°„: " + new Date().toLocaleString() + "\n";
    quickBody += "ì˜¤ë¥˜: " + error.message + "\n\n";
    quickBody += "ìƒì„¸ ì •ë³´ëŠ” ê³§ ë³„ë„ ë©”ì¼ë¡œ ë°œì†¡ë©ë‹ˆë‹¤.";
    
    MailApp.sendEmail("adminpmp@miraepmp.com", quickSubject, quickBody);
  } catch (e) {
    console.error("ì¦‰ì‹œ ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨:", e.message);
  }
}

// ê¸°ì¡´ í•¨ìˆ˜ë“¤ (getLastWeekWeeknum, getWeekNumber, formatDate, getFormattedDate)ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
function getLastWeekWeeknum() {
  const today = new Date();
  today.setHours(today.getHours() + 9); // KSTë¡œ ì‹œê°„ëŒ€ ì¡°ì •
  const lastWeek = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 7);
  const weeknum = getWeekNumber(lastWeek);
  return "WK" + weeknum;
}

function getWeekNumber(date) {
  date.setHours(date.getHours() + 9); // KSTë¡œ ì‹œê°„ëŒ€ ì¡°ì •
  const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
  const daysPassed = Math.floor((date - firstDayOfYear) / (24 * 60 * 60 * 1000));
  const weeknum = Math.ceil((daysPassed + firstDayOfYear.getDay() + 1) / 7);
  return weeknum;
}

function formatDate(date) {
  var d = new Date(date);
  var year = d.getFullYear();
  var month = (d.getMonth() + 1).toString().padStart(2, '0');
  var day = d.getDate().toString().padStart(2, '0');
  return year + '-' + month + '-' + day;
}

function getFormattedDate() {
  var today = new Date();
  var year = today.getFullYear();
  var month = ("0" + (today.getMonth() + 1)).slice(-2);
  var day = ("0" + today.getDate()).slice(-2);
  var formattedDate = year + "-" + month + "-" + day;
  Logger.log(formattedDate);
  return formattedDate;
}